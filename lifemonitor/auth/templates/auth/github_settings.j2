<style>
    .card-disabled {
        pointer-events: none;
        cursor: default;
        opacity: 0.5;
    }
</style>

{% import 'macros.j2' as macros %}

<script>
    function enableGhIntegration() {            
        const el = $("#enable-gh-toggle");            
        if(el){
            const enabled = el.val();
            const toggleClass= enabled === "true" ? "toggle-off" : "toggle-on";
            const newState = $(el.siblings()[0].children).siblings("." + toggleClass)
            newState.css('background', "var(--eosc-yellow)");
            newState.html("<i class='fas fa-sync-alt'></i>");
        }else{
            console.debug("Unable to find element with id: " + iId);
        }
        // submit form
        setTimeout(() => {
            $('#enableGhIntegrationForm').submit();
            //alert("Submit")
        }, 1000);
        
    }
</script>

{% set integration_disabled = not githubSettingsForm.enable_integration.data %}

<form id="enableGhIntegrationForm" method="POST" action="{{ url_for('auth.enable_github_integration') }}">

    <!-- Enable integration -->    
    <div class="form-group text-right px-3 mb-n2">
        <div class="d-inline-block mx-2">
            <small class="form-text text-muted">
                Enable integration
            </small>
        </div>
        <div class="d-inline-block">
            {% set enable_integration = "Toggle off to disable GitHub integration" %}
            {% set disable_integration = "Toggle on to enable GitHub integration" %}
            <div class="checkbox" data-toggle="tooltip" data-placement="top" tooltip-on="{{enable_integration}}"
                tooltip-off="{{disable_integration}}"
                title="{{ enable_integration if githubIntegrationForm.enable_integration.data else disable_integration }}">
                <input id="enable-gh-toggle" class="mx-1"
                    type="checkbox" name="{{githubIntegrationForm.enable_integration.name}}"
                    onchange="enableGhIntegration()"
                    value="{{githubIntegrationForm.enable_integration.data}}" data-toggle="toggle" {% if
                        githubIntegrationForm.enable_integration.data %}checked{% endif%} data-on="on" data-off='off'>
            </div>
        </div>            
    </div>
    
    {{ githubIntegrationForm.hidden_tag() }}
</form>

<div class="{%if integration_disabled %}card-disabled{% endif %}">

    {% if githubAppUrl %}
    <div class="card-header">
        <h3 class="card-title"><b>LifeMonitor GitHub App</b></h3>
    </div>

    <div class="card-body">
        The management page of the LifeMonitor GitHub App is available at 
        <a data-toggle="tooltip" title="LifeMonitor GitHub App Management Page" href="{{githubAppUrl}}" target="_blank">{{githubAppUrl}}</a>
        <span class="ml-1">[<a data-toggle="tooltip" title="LifeMonitor GitHub App Documentation" href="https://lifemonitor.eu/lm_wft_best_practices_github_app#github-app-management-page" target="_blank">docs</a>]</span>.
    </div>
    {% endif %}

    <div class="card-header">
        <h3 class="card-title"><b>Global Settings</b></h3>
    </div>

    <div class="card-body">
        <div class="form-text text-muted p0 mb-4">
            The following settings apply to all repositories
            where you have installed the LifeMonitor GitHub App.
            You can override them for specific repositories
            as explained in the
            <a target="_blank" href="https://lifemonitor.eu/lm_wft_best_practices_github_app#configuration-file">
                configuration guide</a>.
        </div>

        <form method="POST" action="{{ url_for('auth.update_github_settings') }}">

            <!-- Branches to track -->
            <div class="mb-1">
                <label for="{{githubSettingsForm.all_branches.name}}">Repository Branches:</label>
            </div>
            <small class="form-text text-muted my-2">
                LifeMonitor will automatically create and keep up to date
                a workflow version tracking changes for each of the following branches:
            </small>
            <div class="form-group row">
                <div class="col-1">
                    {% set ba_on = "Toggle off to enable the GitHub App only on some branches of your repositories" %}
                    {% set ba_off = "Toggle on to enable the GitHub App on all your repository branches" %}
                    <div class="checkbox" 
                        {% if not integration_disabled %}
                        data-toggle="tooltip" data-placement="top" tooltip-on="{{ba_on}}" tooltip-off="{{ba_off}}"
                        {% endif %}
                        title="{{ ba_on if githubSettingsForm.all_branches.data else ba_off }}">
                        <input id="all_branches" type="checkbox" name="{{githubSettingsForm.all_branches.name}}"
                            {% if integration_disabled %}disabled{% endif %}
                            onchange="toggleInputField('{{githubSettingsForm.all_branches.name}}', '{{githubSettingsForm.branches.name}}', false)"
                            value="{{githubSettingsForm.all_branches.data}}" 
                            data-toggle="toggle" data-on="on"
                            data-off='<i class="fas fa-angle-double-right"></i>' 
                            {% if githubSettingsForm.all_branches.data and not integration_disabled %}checked{% endif %}>
                    </div>
                    <small class="form-text text-muted my-2 mx-0" style="min-width: 150px;">
                        all branches
                    </small>
                </div>
                <div class="col-11">
                    <div class="">
                        {{ macros.render_custom_field(githubSettingsForm.branches, class="ml-5",
                        disabled=githubSettingsForm.all_branches.data or integration_disabled,
                        tooltip_on="List branches separated by comma. Toggle on 'all branches' on the left to enable the
                        GitHub App on all repository branches", ondbclick=True,
                        tooltip_off="Double click to edit the list of repository branches",
                        tooltipPlacement="bottom")}}
                    </div>
                </div>
            </div>

            <!-- Tags to track -->
            <div class="mb-2">
                <label for="{{githubSettingsForm.all_tags.name}}">Repository Tags:</label>
            </div>
            <small class="form-text text-muted my-2">
                LifeMonitor will automatically create
                a workflow version for each of the following tags:
            </small>
            <div class="form-group row">
                <div class="col-1">
                    {% set ta_on = "Toggle off to enable the GitHub App only on some tags of your repositories" %}
                    {% set ta_off = "Toggle on to enable the GitHub App on all repository tags" %}
                    <div class="checkbox"                    
                        {% if not integration_disabled %}
                        data-toggle="tooltip" data-placement="top" tooltip-on="{{ta_on}}" tooltip-off="{{ta_off}}" 
                        {% endif %}
                        title="{{ ta_on if githubSettingsForm.all_tags.data else ta_off }}">
                        <input type="checkbox" name="{{githubSettingsForm.all_tags.name}}"
                            {% if integration_disabled %}disabled{% endif %}
                            value="{{githubSettingsForm.all_tags.data}}"
                            onchange="toggleInputField('{{githubSettingsForm.all_tags.name}}', '{{githubSettingsForm.tags.name}}', false)"
                            {% if githubSettingsForm.all_tags.data and not integration_disabled%}checked{% endif%} 
                            data-toggle="toggle" data-on="all" data-off='<i class="fas fa-angle-double-right"></i>'>
                        <small class="form-text text-muted my-2 mx-1" style="min-width: 150px;">
                            all tags
                        </small>
                    </div>
                </div>
                <div class="col-11">
                    <div class="">
                        {{ macros.render_custom_field(githubSettingsForm.tags, class="ml-5",
                        disabled=githubSettingsForm.all_tags.data or integration_disabled,
                        tooltip_on="List tags separated by comma. Toggle on 'all tags' on the left to enable the
                        GitHub App on all repository tags", ondbclick=True,
                        tooltip_off="Double click to edit the list of repository tags",
                        tooltipPlacement="bottom") }}
                    </div>
                </div>
            </div>

            <!-- Issue Checker -->
            <div class="mb-2">
                <label for="{{githubSettingsForm.check_issues.name}}">Issue Check:</label>
            </div>
            <div class="form-group row">
                <div class="col-2 col-md-1">
                    {% set checks_on = "Toggle off to disable checks on your repositories" %}
                    {% set checks_off = "Toggle on to check for issues on your repositories" %}
                    <div class="checkbox" 
                        {% if not integration_disabled %}
                        data-toggle="tooltip" 
                        data-placement="top" tooltip-on="{{checks_on}}" tooltip-off="{{checks_off}}"
                        {% endif %}
                        title="{{ checks_on if githubSettingsForm.check_issues.data else checks_off }}">
                        <input type="checkbox" name="{{githubSettingsForm.check_issues.name}}"
                            {% if integration_disabled %}disabled{% endif %}
                            onchange="toggleInputField('{{githubSettingsForm.check_issues.name}}', '', false)"
                            value="{{githubSettingsForm.check_issues.data}}" data-toggle="toggle" {% if
                            githubSettingsForm.check_issues.data and not integration_disabled%}checked{% endif%} 
                            data-on="on" data-off='off'>
                    </div>
                </div>
                <div class="col-10 col-md-11 my-auto">
                    <small class="form-text text-muted px-4">
                        LifeMonitor will check for issues on your repositories
                        and will notify them as Github issues or pull requests
                    </small>
                </div>
            </div>

            <!-- Periodic builds -->
            <div style="align-items: start; vertical-align: top;">
            <div class="mt-4">
                <label for="{{githubSettingsForm.periodic_builds.name}}">Periodic Builds:</label>
            </div>
            <small class="form-text text-muted my-2">
                LifeMonitor will activate periodic builds for your repositories, 
                ensuring that no more than a certain amount of time passes between one build and the next. 
                The time interval can be defined by the user through the <b>Build Interval</b> field below.
            </small>
            <div class="form-group row">
                <div class="col-2 col-md-1">
                    {% set periodic_builds_on = "Toggle off to disable periodic builds for your repositories" %}
                    {% set periodic_builds_off = "Toggle on to enable periodic builds for your repositories" %}
                    <div class="checkbox" 
                        {% if not integration_disabled %}
                        data-toggle="tooltip"
                        data-placement="top" tooltip-on="{{periodic_builds_on}}" tooltip-off="{{periodic_builds_off}}"
                        {% endif %}
                        title="{{ periodic_builds_on if githubSettingsForm.periodic_builds.data else periodic_builds_off }}">
                        <input type="checkbox" name="{{githubSettingsForm.periodic_builds.name}}"
                            {% if integration_disabled %}disabled{% endif %}
                            onchange="toggleInputField('{{githubSettingsForm.periodic_builds.name}}', '{{githubSettingsForm.periodic_builds_interval.name}}', true, '{{githubSettingsForm.periodic_builds_wo_ghapp.name}}')"
                            value="{{githubSettingsForm.periodic_builds.data}}" data-toggle="toggle" {% if
                            githubSettingsForm.periodic_builds.data and not integration_disabled %}checked{% endif%} 
                            data-on="on" data-off='off'>
                    </div>
                </div>
                <div class="col-10 col-md-6">
                    <div class="">
                        {{ macros.render_custom_field(githubSettingsForm.periodic_builds_interval, class="ml-5",
                        disabled=not githubSettingsForm.periodic_builds.data or integration_disabled,
                        tooltip_on="Time interval between builds (e.g. 1 week, 1 day, 1 hour, etc.)",
                        tooltip_off="",tooltipPlacement="bottom", icon_class="fas fa-clock") }}
                        <small class="form-text text-muted my-2 ml-5" style="margin-top: 10px !important;">
                            Max time interval between builds (e.g. 1 week, 1 day, 1 hour, etc.)
                        </small>
                    </div>
                </div>
                <div class="col-12 col-md-5 text-right">
                    {% set checks_on = "Toggle off to disable periodic builds for your repositories w/o GitHub app installed." %}
                    {% set checks_off = "Toggle on to periodic builds for your repositories w/o GitHub app installed." %}
                    <div class="checkbox" 
                        {% if not integration_disabled %}
                        data-toggle="tooltip" 
                        data-placement="top" tooltip-on="{{checks_on}}" tooltip-off="{{checks_off}}"
                        {% endif %}
                        title="{{ checks_on if githubSettingsForm.periodic_builds_wo_ghapp.data else checks_off }}">
                        <label class="mx-2" for="{{githubSettingsForm.periodic_builds_wo_ghapp.name}}">w/o GitHub App</label>
                        <input type="checkbox" name="{{githubSettingsForm.periodic_builds_wo_ghapp.name}}"
                            {% if integration_disabled or not githubSettingsForm.periodic_builds.data %}disabled{% endif %}
                            onchange="toggleInputField('{{githubSettingsForm.periodic_builds_wo_ghapp.name}}', '')"
                            value="{{githubSettingsForm.periodic_builds_wo_ghapp.data}}" data-toggle="toggle" {% if
                            githubSettingsForm.periodic_builds_wo_ghapp.data and not integration_disabled%}checked{% endif%} 
                            data-on="on" data-off='off'>                        
                    </div>                    
                    <small class="form-text text-muted my-5 my-md-auto" style="margin-top: 10px !important;">
                        LifeMonitor will activate periodic builds for your repositories
                        which don't have the GitHub App installed.
                    </small>            
                </div>
            </div>
            </div>


            <!-- Button to save settings -->
            <div class="form-group pt-5 text-center">
                <button type="submit" 
                        class="btn btn-primary text-bold {% if integration_disabled %}disabled{% endif %}" 
                        style="width: 120px">Save</button>
            </div>

            <input type="hidden" name="{{ githubSettingsForm.enable_integration.name }}" 
                value="{{ githubSettingsForm.enable_integration.data }}">

            {{ githubSettingsForm.hidden_tag() }}
            
        </form>

    </div>

</div>

    

<script>

    var initTriggers = false;

    function toggleInputField(toggleFieldName, dataFieldName, enableDataOnChecked = true, secondaryToggleFieldName = null) {
        var toggleFieldElement = $("input[name=" + toggleFieldName + "]");
        if (!toggleFieldElement) return;
        var disabled = !(toggleFieldElement.prop('checked'));
        updateFieldTooltip(toggleFieldElement, disabled);
        // update secondary toggle field element
        console.log("Secondary:  " + secondaryToggleFieldName);
        if (secondaryToggleFieldName && disabled) {
            //toggleInputField(secondaryToggleFieldName, null, null, null);
            var checkbox = $(`input[name=${secondaryToggleFieldName}]`);
            console.log(checkbox);
            checkbox.bootstrapToggle('off');
        }
        // update data field element
        if (!dataFieldName) return;
        var dataFieldElement = $("input[name=" + dataFieldName + "]");
        if (dataFieldElement) {
            var dataEnabled = (!enableDataOnChecked || enableDataOnChecked === false) ? disabled : !disabled;
            dataFieldElement.prop("disabled", !dataEnabled).change();
            updateFieldTooltip(dataFieldElement, !dataEnabled);
        }
    }

    function updateFieldTooltip(el, disabled) {
        var parent = el.closest("[data-toggle=tooltip]");
        console.log(parent);
        if (parent) {
            parent.attr('data-original-title', parent.attr(disabled ? 'tooltip-off' : 'tooltip-on'));
        }
    }

    function onInputFieldEnabled(fieldName) {
        $('#' + fieldName).on('enabled', () => {
            var checkbox = $(`input[name=all_${fieldName}]`);
            console.log(fieldName, checkbox);
            if (checkbox) {
                checkbox.prop('checked', false).change();
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        onInputFieldEnabled('branches');
        onInputFieldEnabled('tags');
    });

</script>